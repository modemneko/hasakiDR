# hasakiDR 文档

## 目录

1. [项目概述](#项目概述)
2. [架构设计](#架构设计)
3. [核心组件](#核心组件)
4. [API 参考](#api-参考)
5. [安装与配置](#安装与配置)
6. [使用指南](#使用指南)
7. [技术细节](#技术细节)
8. [未来增强](#未来增强)

## 项目概述

hasakiDR 是一个基于 AI 的研究助手，能够自动收集、分析和综合来自多个来源的信息，生成较为全面的研究报告。结合了LLM、AgentBrowser和Graph节点工作流程。

### 主要功能

- **多引擎搜索**：通过 SearXNG 利用多个搜索引擎收集多样化信息
- **AI 驱动分析**：使用大型语言模型分析和综合信息
- **结构化工作流程**：实现基于状态的工作流程，进行系统化研究
- **实时进度跟踪**：通过 Web 界面提供研究进度更新
- **全面报告生成**：生成包含发现和见解的详细研究报告
- **用户友好界面**：提供直观的 Web UI 用于提交查询和查看结果

## 架构设计

hasakiDR 系统采用模块化架构，具有明确的关注点分离：

```
┌─────────────────────────────────────────────────────────────────────┐
│                          Web 界面                                  │
│   (HTML/CSS/JavaScript 结合现代样式框架)                           │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────────────┐
│                           API 层                                   │
│          (API 端点，用于计划/研究管理)                              │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────────────┐
│                        工作流引擎                                  │
│               (基于状态的工作流系统)                                │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────────────┐
│                           AI 层                                    │
│         (大型语言模型，用于分析和生成)                             │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
┌──────────────────────────────▼──────────────────────────────────────┐
│                       搜索与浏览器层                               │
│   (多引擎搜索能力，支持网页浏览功能)                              │
└─────────────────────────────────────────────────────────────────────┘
```

### 工作流程图

研究过程遵循基于状态的结构化工作流程：

1. **规划节点**：基于初始查询生成研究计划
2. **研究节点**：执行多引擎搜索并提取相关信息
3. **综合节点**：分析和综合来自不同来源的发现
4. **最终报告节点**：生成全面的研究报告

工作流程包含条件边，根据收集信息的质量和完整性决定是继续研究迭代还是进行报告生成。

## 核心组件

### 1. Web 界面 (`static/index.html`)

用户面向的组件，使用 HTML、CSS 和 JavaScript 构建，通过 Tailwind CSS 增强样式。它提供：

- 类似聊天的界面，用于提交研究查询
- 实时显示研究进度和中间结果
- 计划生成和确认功能
- 报告查看和复制功能
- 响应式设计，适用于不同屏幕尺寸

### 2. API 层 (`main.py`)

基于 FastAPI 的后端，处理 HTTP 请求并协调研究过程：

- `/plan`：为给定查询生成研究计划
- `/research`：使用计划启动研究过程
- `/research_progress`：返回正在进行的研究的状态和结果
- `/completed_reports`：列出所有已完成的研究报告
- `/report/{query}`：检索特定的已完成报告

### 3. 工作流引擎 (`graph.py`)

使用 LangGraph 实现基于状态的工作流：

- **状态管理**：在整个过程中维护研究状态
- **节点协调**：管理不同工作流节点的执行
- **条件逻辑**：确定何时继续研究或生成报告

### 4. AI 层

#### 节点 (`nodes.py`)

- **规划节点**：基于查询和先前发现创建研究任务
- **研究节点**：执行网络搜索并分析结果
- **综合节点**：整合来自多个来源的发现
- **最终报告节点**：生成全面的研究报告

#### 语言模型配置 (`config.py`)

支持多个 AI 模型，可根据不同的使用场景和性能需求进行配置

### 5. 搜索层 (`nodes.py`)

- **searxng_search 函数**：查询 SearXNG API 以收集来自多个搜索引擎的结果
- **结果处理**：提取并格式化搜索结果以进行分析
- **Agent 浏览器集成**：使用 `browser_use` 模块提供潜在的网页浏览能力
  - 初始化 `Browser` 实例用于网页导航
  - 设计支持网页浏览代理以执行更复杂的研究任务
  - 当前使用直接的 SearXNG API 调用来实现搜索功能

### 6. 状态管理 (`research_state.py`)

- **ResearchState**：用于维护研究上下文的 TypedDict 结构
- **状态转换**：定义状态如何在工作流节点之间变化

## API 参考

### 1. POST /plan

为给定查询生成研究计划。

**请求体**：
```json
{
  "query": "您的研究主题"
}
```

**响应**：
```json
{
  "plan": "生成的研究计划文本"
}
```

### 2. POST /research

使用计划启动研究过程。

**请求体**：
```json
{
  "query": "您的研究主题",
  "plan": "研究计划文本",
  "max_iterations": 3
}
```

**响应**：
```json
{
  "report": "研究已启动，请稍后查看研究进度。"
}
```

### 3. GET /research_progress

返回正在进行的研究的状态和结果。

**查询参数**：
- `query`：原始研究查询

**响应**：
```json
{
  "progress": "当前进度状态",
  "final_report": "生成的报告（如果完成）",
  "logs": [
    {
      "type": "node_type",
      "content": "日志内容"
    }
  ],
  "is_complete": true/false,
  "error": "错误消息（如果有）",
  "elapsed_time": 10.5
}
```

### 4. GET /completed_reports

列出所有已完成的研究报告。

**响应**：
```json
[
  {
    "query": "研究主题",
    "timestamp": "2024-01-01T12:00:00",
    "elapsed_time": 15.2,
    "has_error": false
  }
]
```

### 5. GET /report/{query}

检索特定的已完成报告。

**路径参数**：
- `query`：原始研究查询

**响应**：
```json
{
  "query": "研究主题",
  "report": "生成的报告内容",
  "timestamp": "2024-01-01T12:00:00",
  "elapsed_time": 15.2,
  "error": "错误消息（如果有）"
}
```

## 安装与配置

### 前提条件

- Python 3.8+
- pip（Python 包管理器）
- 访问 Ollama 或 Google Gemini API
- 访问 SearXNG 实例

### 安装步骤

1. **克隆仓库**：
   ```bash
   git clone <repository-url>
   cd hasakiDR
   ```

2. **安装依赖**：
   ```bash
   pip install -r requirements.txt
   ```

3. **配置 API 密钥**：
   - 对于 Google Gemini：在 `config.py` 中更新 `GOOGLE_API_KEY`
   - 对于 Ollama：确保 Ollama 正在运行所需的模型

4. **配置搜索引擎**：
   - 如需更改，更新 `nodes.py` 中的 `searxng_url`

5. **启动服务器**：
   ```bash
   python main.py
   ```

6. **访问应用**：
   打开 Web 浏览器并导航到 `http://localhost:11451`

## 使用指南

### 1. 提交研究查询

1. 打开 hasakiDR Web 界面
2. 在输入字段中输入您的研究主题
3. 根据需要调整最大迭代次数（默认值：3）
4. 点击 "开始研究"

### 2. 审查研究计划

1. 系统将生成研究计划
2. 审查计划并选择：
   - 点击 "同意" 以按计划进行
   - 点击 "修改" 以自定义计划

### 3. 监控研究进度

- 聊天界面将显示来自每个工作流节点的实时更新
- 进度指示器将显示当前状态
- 等待研究完成

### 4. 查看研究报告

1. 研究完成后，点击 "点击查看报告"
2. 报告将在侧边抽屉中打开
3. 使用 "📋 复制" 按钮复制报告
4. 完成后关闭抽屉

## 技术细节

### 工作流执行

研究工作流使用基于状态的方法实现：

1. **初始化**：工作流在启动时编译一次
2. **状态管理**：在整个研究过程中维护上下文
3. **节点执行**：每个处理节点处理当前状态并返回更新
4. **条件转换**：逻辑确定是继续研究还是生成报告
5. **流处理**：结果流式传输回客户端以进行实时更新

### 搜索实现

- 使用元搜索引擎从多个来源收集结果
- 实现错误处理以确保搜索操作的稳定性
- 处理和格式化搜索结果以进行 AI 分析
- 集成网页浏览能力以支持潜在的复杂研究任务
  - 网页导航功能用于全面的数据收集
  - 设计支持交互式浏览和数据提取
  - 当前配置为高效的搜索功能

### AI 集成

- 集成多种 AI 模型用于分析和生成
- 支持基于云的和本地部署的模型选项
- 实现异步处理以提高性能

### 前端架构

- 纯 HTML/CSS/JavaScript 实现
- Tailwind CSS 用于响应式设计
- Marked.js 用于 Markdown 渲染
- 通过轮询进行实时更新

## 未来增强

1. **高级搜索功能**
   - 支持更多专业搜索引擎
   - 自定义搜索过滤器和参数
   - 直接 URL 提交特定来源
   - 充分利用网页浏览能力
     - 实现用于复杂研究任务的网页导航代理
     - 支持交互式网页浏览和数据提取
     - 增强处理动态网页内容的能力

2. **增强的 AI 功能**
   - 多模型比较和集成方法
   - 针对特定研究领域的微调模型
   - 改进的推理和引用能力

3. **用户体验改进**
   - 使用 WebSocket 实时更新代替轮询
   - 交互式报告编辑和自定义
   - 不同格式的导出选项（PDF、DOCX 等）

4. **可扩展性和性能**
   - 使用 Celery 进行后台任务处理
   - 常见查询和搜索结果的缓存
   - 多主题研究的并行执行

5. **安全增强**
   - API 密钥保护和轮换
   - 输入验证和清理
   - 速率限制和访问控制

6. **附加功能**
   - 引用和参考管理
   - 研究历史和收藏
   - 协作研究能力

## 结论

hasakiDR 代表了一种强大的自动化研究方法，结合了网络搜索、AI 分析和结构化工作流的优势。其模块化架构和可扩展设计使其适合广泛的研究应用，从学术研究到市场分析等。

通过利用现代 AI 技术和以用户为中心的设计，hasakiDR 简化了研究过程，使用户能够专注于分析和决策，而不是信息收集和综合。
